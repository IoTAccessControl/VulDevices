/*
 * Copyright (c) 2012-2014 Wind River Systems, Inc.
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <zephyr.h>
#include <misc/printk.h>
#include <console.h>
#include <stdio.h>
#include <string.h>

#include "include/patch_service.h"
#include "include/iotpatch.h"
#include "libebpf/include/ebpf_allocator.h"
#include "include/utils.h"

#include "hotpatch/include/profiling.h"

#include "app/ihp_cli.h"

#ifdef DEV_COAP
#include "common.h"
#endif

#ifdef DEV_MQTT
#include "config.h"
#endif

static uint8_t fixed_patch_0[64] = ""
"\x01\x00\x38\x00\x00\x00\x00\x00\x61\x11\x04\x00\x00\x00\x00\x00\x67\x01\x00\x00\x20\x00\x00\x00\xc7"
"\x01\x00\x00\x20\x00\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\x65\x01\x01\x00\x13\x00\x00\x00\xb7\x00"
"\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

static uint8_t sign_0[16] = "\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73\x73";

typedef struct stack_frame {
	uint32_t r0;
	uint32_t r1;
	uint32_t r2;
	uint32_t r3;
	uint32_t r12; // ip
	uint32_t lr;
	uint32_t pc; // return address
	uint32_t xpsr;
} stack_frame;

// cve-2020-10063

static uint16_t coap_len = 21;

static uint8_t fixed_patch_10063[128] = ""
"\x01\x00\x78\x00\x00\x00\x00\x00\x61\x11\x04\x00\x00\x00\x00\x00\x07\x01\x00\x00\x05\x00\x00\x00\x67"
"\x01\x00\x00\x20\x00\x00\x00\x77\x01\x00\x00\x20\x00\x00\x00\x69\x12\x00\x00\x00\x00\x00\x00\x18\x01"
"\x00\x00\xea\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x25\x02\x01\x00\xff\xef\x00\x00\xb7\x01\x00"
"\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\x25\x02\x01\x00\xff\xef\x00\x00\xb7\x00\x00\x00"
"\x00\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x4f\x10\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00"
"\x00\x00\x00"
"";

// cve-2020-10021

static uint16_t usb_target = 21;
static uint16_t mem_size = 100;

static uint8_t fixed_patch_10021[96] = ""
"\x01\x00\x58\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x61\x12\x00\x00\x00\x00\x00\x00\x61"
"\x13\x04\x00\x00\x00\x00\x00\x61\x33\x00\x00\x00\x00\x00\x00\x2d\x23\x04\x00\x00\x00\x00\x00\xb7\x03"
"\x00\x00\x7c\x97\x00\x00\x63\x31\x14\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x01\x00\x00\x00\x4f\x20\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

// cve-2020-10024

static uint8_t fixed_patch_10024[88] = ""
"\x01\x00\x50\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x71\x12\x1f\x00\x00\x00\x00\x00\x57"
"\x02\x00\x00\x20\x00\x00\x00\x15\x02\x05\x00\x00\x00\x00\x00\x61\x12\x18\x00\x00\x00\x00\x00\x07\x02"
"\x00\x00\x04\x00\x00\x00\x63\x21\x14\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x01\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

// cve-2020-10028

static struct gpio_struct2 {
	int a;
	int b;
	int c;
	int d;
	int *e;
};

static struct gpio_struct1 {
	int a;
	struct gpio_struct2* b;
};

static uint8_t fixed_patch_10028[112] = ""
"\x01\x00\x68\x00\x00\x00\x00\x00\x61\x11\x04\x00\x00\x00\x00\x00\x61\x11\x04\x00\x00\x00\x00\x00\x61"
"\x12\x00\x00\x00\x00\x00\x00\x18\x01\x00\x00\xea\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x15\x02"
"\x01\x00\x00\x00\x00\x00\xb7\x01\x00\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\x15\x02\x01"
"\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x4f\x10\x00\x00"
"\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

// cve-2020-10062

struct mqtt_buf_ctx {
	unsigned char *cur;
    unsigned char *end;
};

static uint8_t fixed_patch_10062[440] = ""
"\x01\x00\xb0\x01\x00\x00\x00\x00\xb7\x03\x00\x00\x01\x00\x00\x00\x61\x11\x00\x00\x00\x00\x00\x00\x79"
"\x12\x00\x00\x00\x00\x00\x00\x71\x21\x00\x00\x00\x00\x00\x00\x67\x01\x00\x00\x38\x00\x00\x00\xc7\x01"
"\x00\x00\x38\x00\x00\x00\x65\x01\x06\x00\xff\xff\xff\xff\xb7\x03\x00\x00\x02\x00\x00\x00\x71\x24\x01"
"\x00\x00\x00\x00\x00\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00\x38\x00\x00\x00\xb7\x05\x00\x00"
"\x00\x00\x00\x00\x6d\x45\x17\x00\x00\x00\x00\x00\x57\x01\x00\x00\x7f\x00\x00\x00\x55\x03\x04\x00\x01"
"\x00\x00\x00\xb7\x00\x00\x00\xea\xff\xff\xff\x25\x01\x01\x00\xff\xff\xff\x0f\xb7\x00\x00\x00\x00\x00"
"\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00\x71\x24\x01\x00\x00\x00\x00\x00\x57\x04\x00\x00\x7f\x00\x00"
"\x00\x67\x04\x00\x00\x07\x00\x00\x00\x4f\x14\x00\x00\x00\x00\x00\x00\xbf\x41\x00\x00\x00\x00\x00\x00"
"\x15\x03\xf6\xff\x02\x00\x00\x00\x71\x21\x02\x00\x00\x00\x00\x00\x57\x01\x00\x00\x7f\x00\x00\x00\x67"
"\x01\x00\x00\x0e\x00\x00\x00\x4f\x41\x00\x00\x00\x00\x00\x00\x15\x03\xf1\xff\x03\x00\x00\x00\x71\x22"
"\x03\x00\x00\x00\x00\x00\x57\x02\x00\x00\x7f\x00\x00\x00\x67\x02\x00\x00\x15\x00\x00\x00\x4f\x12\x00"
"\x00\x00\x00\x00\x00\xbf\x21\x00\x00\x00\x00\x00\x00\x05\x00\xeb\xff\x00\x00\x00\x00\xb7\x03\x00\x00"
"\x03\x00\x00\x00\x71\x24\x02\x00\x00\x00\x00\x00\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00\x38"
"\x00\x00\x00\x65\x04\xe4\xff\xff\xff\xff\xff\xb7\x03\x00\x00\x04\x00\x00\x00\x71\x24\x03\x00\x00\x00"
"\x00\x00\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00\x38\x00\x00\x00\x65\x04\xdf\xff\xff\xff\xff"
"\xff\x18\x00\x00\x00\xea\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x71\x24\x04\x00\x00\x00\x00\x00"
"\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00\x38\x00\x00\x00\xb7\x03\x00\x00\x01\x00\x00\x00\x65"
"\x04\xdd\xff\xff\xff\xff\xff\x05\x00\xd7\xff\x00\x00\x00\x00"
"";

// cve-2018-16524

static struct IPPacket {
	unsigned char padd[24];
	unsigned char *tcpptr;
};

static struct TCPPacket {
	unsigned char data[60];
};

static uint8_t fixed_patch_16524[368] = ""
"\x01\x00\x68\x01\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x61\x11\x04\x00\x00\x00\x00\x00\x71"
"\x11\x18\x00\x00\x00\x00\x00\x71\x12\x2e\x00\x00\x00\x00\x00\xb7\x03\x00\x00\x60\x00\x00\x00\x2d\x23"
"\x26\x00\x00\x00\x00\x00\x77\x02\x00\x00\x02\x00\x00\x00\x57\x02\x00\x00\x3c\x00\x00\x00\x0f\x12\x00"
"\x00\x00\x00\x00\x00\x07\x02\x00\x00\x22\x00\x00\x00\x07\x01\x00\x00\x36\x00\x00\x00\x71\x13\x00\x00"
"\x00\x00\x00\x00\x65\x03\x03\x00\x01\x00\x00\x00\x15\x03\x06\x00\x01\x00\x00\x00\x15\x03\x1d\x00\x00"
"\x00\x00\x00\x05\x00\x02\x00\x00\x00\x00\x00\x15\x03\x0b\x00\x02\x00\x00\x00\x15\x03\x05\x00\x03\x00"
"\x00\x00\x71\x13\x01\x00\x00\x00\x00\x00\x05\x00\x13\x00\x00\x00\x00\x00\x07\x01\x00\x00\x01\x00\x00"
"\x00\x2d\x12\xf5\xff\x00\x00\x00\x00\x05\x00\x15\x00\x00\x00\x00\x00\x71\x13\x01\x00\x00\x00\x00\x00"
"\x55\x03\x0e\x00\x03\x00\x00\x00\x07\x01\x00\x00\x03\x00\x00\x00\x2d\x12\xf0\xff\x00\x00\x00\x00\x05"
"\x00\x10\x00\x00\x00\x00\x00\x71\x13\x01\x00\x00\x00\x00\x00\x55\x03\x09\x00\x04\x00\x00\x00\x71\x12"
"\x03\x00\x00\x00\x00\x00\x71\x11\x02\x00\x00\x00\x00\x00\x67\x01\x00\x00\x08\x00\x00\x00\x4f\x21\x00"
"\x00\x00\x00\x00\x00\x57\x01\x00\x00\xff\xff\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\x15\x01\x06\x00"
"\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x05\x00\x04\x00\x00\x00\x00\x00\x0f\x31\x00\x00\x00"
"\x00\x00\x00\x15\x03\x03\x00\x00\x00\x00\x00\x2d\x12\xe1\xff\x00\x00\x00\x00\x05\x00\x01\x00\x00\x00"
"\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

// cve-2018-16603

static struct ETHPacket {
	unsigned char padd[28];
	uint64_t xDataLength;
};

static uint8_t fixed_patch_16603[80] = ""
"\x01\x00\x48\x00\x00\x00\x00\x00\x61\x11\x00\x00\x00\x00\x00\x00\x79\x11\x1c\x00\x00\x00\x00\x00\x07"
"\x01\x00\x00\xde\xff\xff\xff\xb7\x00\x00\x00\x01\x00\x00\x00\xb7\x02\x00\x00\x14\x00\x00\x00\x2d\x12"
"\x01\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x95\x00\x00"
"\x00\x00\x00\x00\x00"
"";

// cve-2020-17443

static struct PicoFrame {
	unsigned char padd[38];
	uint16_t transport_len;
};

static uint8_t fixed_patch_17443[112] = ""
"\x01\x00\x68\x00\x00\x00\x00\x00\x61\x11\x00\x00\x00\x00\x00\x00\x69\x12\x26\x00\x00\x00\x00\x00\x18"
"\x01\x00\x00\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\xb7\x03\x00\x00\x08\x00\x00\x00\x2d\x23"
"\x01\x00\x00\x00\x00\x00\xb7\x01\x00\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\x2d\x23\x01"
"\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x4f\x10\x00\x00"
"\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

// cve-2020-17445

static uint8_t fixed_patch_17445[288] = ""
"\x01\x00\x18\x01\x00\x00\x00\x00\x61\x12\x00\x00\x00\x00\x00\x00\x61\x13\x08\x00\x00\x00\x00\x00\x07"
"\x03\x00\x00\x02\x00\x00\x00\x71\x21\x01\x00\x00\x00\x00\x00\x07\x02\x00\x00\x02\x00\x00\x00\x67\x01"
"\x00\x00\x03\x00\x00\x00\x47\x01\x00\x00\x06\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x01\x00\x00\x00\x18\x04\x00\x00\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x71\x25\x01\x00"
"\x00\x00\x00\x00\x07\x05\x00\x00\x02\x00\x00\x00\xbf\x57\x00\x00\x00\x00\x00\x00\x57\x07\x00\x00\xff"
"\x00\x00\x00\x15\x07\x11\x00\x00\x00\x00\x00\xbf\x36\x00\x00\x00\x00\x00\x00\x0f\x76\x00\x00\x00\x00"
"\x00\x00\xbf\x67\x00\x00\x00\x00\x00\x00\x67\x07\x00\x00\x20\x00\x00\x00\x77\x07\x00\x00\x20\x00\x00"
"\x00\x67\x03\x00\x00\x20\x00\x00\x00\x77\x03\x00\x00\x20\x00\x00\x00\x3d\x73\x09\x00\x00\x00\x00\x00"
"\x1f\x51\x00\x00\x00\x00\x00\x00\x57\x05\x00\x00\xff\x00\x00\x00\x0f\x52\x00\x00\x00\x00\x00\x00\xb7"
"\x04\x00\x00\x00\x00\x00\x00\xbf\x15\x00\x00\x00\x00\x00\x00\x57\x05\x00\x00\xff\x00\x00\x00\xbf\x63"
"\x00\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x55\x05\xe6\xff\x00\x00\x00\x00\x4f\x40\x00"
"\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";


ebpf_patch *get_patch(uint8_t *patch_bytes, int pkt_len) {
	patch_payload paylod;
	paylod.pkt = ebpf_malloc(pkt_len);
	memcpy(paylod.sign, sign_0, 16);
	memcpy(paylod.pkt, patch_bytes, pkt_len);
	patch_desc *patch_d = (patch_desc*) (paylod.pkt);
	ebpf_patch *patch = ebpf_patch_setup(patch_d);
	// DEBUG_LOG("packet size: %d patch type:%d code_len:%d addr:0x%08x\n", pkt_len, patch->type, patch->code_len, patch->inst_addr);
	return patch;
}

K_THREAD_DEFINE(cli_thread, STACK_SIZE,
	run_shell_cli, NULL, NULL, NULL,
	THREAD_PRIORITY, 0, K_FOREVER);

static void load_fixed_patch_0(void);

void main(void)
{

	console_init();
	//printk("Hello World! %s\n", CONFIG_BOARD);
	k_thread_start(cli_thread);

	profile_add_event("micro profile dynamic start");
	profile_add_event("micro profile fixed start");
	profile_add_event("uart print profile start");
	profile_add_event("eBPF exec time evaluation start");

	#ifdef DEV_COAP
	// run_coap_server();
	#endif

	#ifdef DEV_MQTT
	// run_mqtt_subscriber();
	#endif

	start_patch_service();
	load_fixed_patch_0();

	// static struct stack_frame sf_10063 = {
	// 	.r0 = 0,
	// 	.r1 = ((uint32_t)(&coap_len)) - 5,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// eBPF exec time evaluation
	// ebpf_patch *patch = get_patch(fixed_patch_10063, 128);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_10063, sizeof(sf_10063));
	// profile_end(3);
	// profile_dump(3);

	// struct stack_frame sf_10021 = {
	// 	.r0 = usb_target,
	// 	.r1 = ((uint32_t)(&mem_size)),
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_10021, 96);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_10021, sizeof(sf_10021));
	// profile_end(3);
	// profile_dump(3);

	// struct stack_frame sf_10024 = {
	// 	.r0 = 0,
	// 	.r1 = 0,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_10024, 88);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_10024, sizeof(sf_10024));
	// profile_end(3);
	// profile_dump(3);

	// struct gpio_struct2 g2 = {
	// 	.a = 0,
	// 	.b = 0,
	// 	.c = 0,
	// 	.d = 0,
	// 	.e = 0,
	// };

	// struct gpio_struct1 g1 = {
	// 	.a = 0,
	// 	.b = &g2,
	// };

	// struct stack_frame sf_10028 = {
	// 	.r0 = 0,
	// 	.r1 = &g1,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_10028, 112);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_10028, sizeof(sf_10028));
	// profile_end(3);
	// profile_dump(3);

	// unsigned char mqtt_buf[6] = {0x81, 0x81, 0, 0, 0, 0};
	// struct mqtt_buf_ctx mbc = {
	// 	.cur = mqtt_buf,
	// 	.end = mqtt_buf + 5,
	// };

	// struct stack_frame sf_10062 = {
	// 	.r0 = &mbc,
	// 	.r1 = 0,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_10062, 440);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_10062, sizeof(sf_10062));
	// profile_end(3);
	// profile_dump(3);

	// struct TCPPacket tcppkt = {
	// 	.data = {0},
	// };

	// struct IPPacket ippkt = {
	// 	.padd = {0},
	// 	.tcpptr = &tcppkt,
	// };

	// struct stack_frame sf_16524 = {
	// 	.r0 = 0,
	// 	.r1 = &ippkt,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_16524, 368);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_16524, sizeof(sf_16524));
	// profile_end(3);
	// profile_dump(3);

	// struct ETHPacket ethpkt = {
	// 	.padd = {0},
	// 	.xDataLength = 100,
	// };

	// struct stack_frame sf_16603 = {
	// 	.r0 = &ethpkt,
	// 	.r1 = 0,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_16603, 80);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_16603, sizeof(sf_16603));
	// profile_end(3);
	// profile_dump(3);

	// struct PicoFrame pf = {
	// 	.padd = {0},
	// 	.transport_len = 7,
	// };

	// struct stack_frame sf_17443 = {
	// 	.r0 = &pf,
	// 	.r1 = 0,
	// 	.r2 = 0,
	// 	.r3 = 0,
	// 	.r12 = 0,
	// 	.lr = 0,
	// 	.pc = 0,
	// 	.xpsr = 0,
	// };

	// ebpf_patch *patch = get_patch(fixed_patch_17443, 112);
	// profile_start(3);
	// int ret = run_ebpf_filter(patch, &sf_17443, sizeof(sf_17443));
	// profile_end(3);
	// profile_dump(3);

	uint32_t opt_ptr = 0;
	uint8_t destopt[50] = {1};

	struct stack_frame sf_17445 = {
		.r0 = destopt,
		.r1 = 0,
		.r2 = opt_ptr,
		.r3 = 0,
		.r12 = 0,
		.lr = 0,
		.pc = 0,
		.xpsr = 0,
	};

	ebpf_patch *patch = get_patch(fixed_patch_17445, 288);
	profile_start(3);
	int ret = run_ebpf_filter(patch, &sf_17445, sizeof(sf_17445));
	profile_end(3);
	profile_dump(3);
}

static void load_fixed_patch_0(void) {
	patch_payload paylod;
	int pkt_len = 64;
	paylod.pkt = ebpf_malloc(pkt_len);
	memcpy(paylod.sign, sign_0, 16);
	memcpy(paylod.pkt, fixed_patch_0, pkt_len);
	patch_desc *patch = (patch_desc*) (paylod.pkt);
	DEBUG_LOG("packet size: %d patch type:%d code_len:%d addr:0x%08x\n", pkt_len, patch->type, patch->code_len, patch->inst_addr);
	notify_new_patch(patch);
}

